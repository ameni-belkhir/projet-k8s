---
# 1. Protection contre les verrous APT & Réparations
    # -------------------------------------------------------------------------
    - name: Attendre que le verrou APT soit libéré
      shell: while fuser /var/lib/dpkg/lock-frontend >/dev/null 2>&1; do sleep 5; done;
      changed_when: false

    - name: Réparer les installations de paquets interrompues
      shell: |
        dpkg --configure -a
        apt-get install -f -y
      ignore_errors: yes

    # 2. System Preparation
    # -------------------------------------------------------------------------
    - name: Remove old Kubernetes repositories
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - /etc/apt/sources.list.d/kubernetes.list
        - /etc/apt/keyrings/kubernetes-apt-keyring.asc

    - name: Disable Swap
      shell: |
        swapoff -a
        sed -i '/\sswap\s/ s/^\(.*\)$/#\1/g' /etc/fstab
      when: ansible_swaptotal_mb > 0

    - name: Load kernel modules
      modprobe:
        name: "{{ item }}"
        state: present
      loop: [overlay, br_netfilter]

    - name: Configure sysctl for networking
      sysctl:
        name: "{{ item.key }}"
        value: "{{ item.value }}"
        state: present
        reload: yes
      loop:
        - { key: 'net.bridge.bridge-nf-call-iptables', value: '1' }
        - { key: 'net.ipv4.ip_forward', value: '1' }

    # 3. Dependencies & CRI-Dockerd
    # -------------------------------------------------------------------------
    - name: Create keyrings directory
      file:
        path: /etc/apt/keyrings
        state: directory
        mode: '0755'

    - name: Setup Kubernetes Repository
      shell: |
        curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.29/deb/Release.key | gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg --yes
        echo "deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.29/deb/ /" > /etc/apt/sources.list.d/kubernetes.list

    - name: Install Docker and K8s tools
      apt:
        name: [docker.io, kubelet, kubeadm, kubectl]
        state: present
        update_cache: yes

    - name: Configure Docker (Cgroup systemd)
      copy:
        dest: /etc/docker/daemon.json
        content: |
          {
            "exec-opts": ["native.cgroupdriver=systemd"],
            "log-driver": "json-file",
            "storage-driver": "overlay2"
          }

    - name: Install and Start cri-dockerd
      block:
        - name: Download cri-dockerd (Fix corrupted download)
          shell: |
            cd /tmp
            curl -L -o cri-dockerd.deb https://github.com/Mirantis/cri-dockerd/releases/download/v0.3.10/cri-dockerd_0.3.10.3-0.ubuntu-jammy_amd64.deb
        - name: Install deb
          apt:
            deb: /tmp/cri-dockerd.deb
            state: present
        - name: Ensure services are running
          systemd:
            name: "{{ item }}"
            state: restarted
            enabled: yes
            daemon_reload: yes
          loop: [docker, cri-docker]

    # 4. Master Node Initialization
    # -------------------------------------------------------------------------
    - name: Initialize Kubernetes Master
      command: >
        kubeadm init --pod-network-cidr=192.168.0.0/16 
        --token={{ token }} 
        --cri-socket unix:///var/run/cri-dockerd.sock 
        --ignore-preflight-errors=all
      args:
        creates: /etc/kubernetes/admin.conf
      when: "'master' in ansible_hostname"

    - name: Setup Kubeconfig for Ubuntu
      block:
        - name: Create kube dir
          file:
            path: /home/ubuntu/.kube
            state: directory
            owner: ubuntu
            group: ubuntu
        - name: Copy admin.conf
          copy:
            src: /etc/kubernetes/admin.conf
            dest: /home/ubuntu/.kube/config
            remote_src: yes
            owner: ubuntu
            group: ubuntu
            mode: '0600'
      when: "'master' in ansible_hostname"

    # 5. Network & Monitoring (MASTER ONLY - FIXED TIMEOUT)
    # -------------------------------------------------------------------------
    - name: Install Calico & Prometheus
      when: "'master' in ansible_hostname"
      block:
        - name: Calico Network
          become: yes
          become_user: ubuntu
          shell: |
            kubectl apply -f https://raw.githubusercontent.com/projectcalico/calico/v3.27.0/manifests/tigera-operator.yaml --server-side
            sleep 15
            kubectl apply -f https://raw.githubusercontent.com/projectcalico/calico/v3.27.0/manifests/custom-resources.yaml
          register: calico_res
          until: calico_res.rc == 0
          retries: 3
          delay: 10

        - name: Install Helm
          shell: |
            if ! command -v helm &> /dev/null; then 
              curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
            fi
          changed_when: false

        - name: Deploy Prometheus Stack via Helm (ASYNC)
          shell: |
            helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
            helm repo update
            export KUBECONFIG=/etc/kubernetes/admin.conf
            helm upgrade --install prometheus prometheus-community/kube-prometheus-stack \
              --namespace monitoring \
              --create-namespace \
              --timeout 15m0s
          register: helm_out
          failed_when: "helm_out.rc != 0 and 'already exists' not in helm_out.stderr"

    # 6. Worker Node Logic (FIXED IP)
    # -------------------------------------------------------------------------
    - name: Join Worker nodes to Cluster
      command: >
        kubeadm join {{ master_ip }}:6443 
        --token={{ token }} 
        --discovery-token-unsafe-skip-ca-verification 
        --cri-socket unix:///var/run/cri-dockerd.sock
      args:
        creates: /etc/kubernetes/kubelet.conf
      when: "'worker' in ansible_hostname"
