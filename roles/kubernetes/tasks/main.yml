---
# 1. Nettoyage et Réparation Initiale
# -------------------------------------------------------------------------
- name: Nettoyer les fichiers corrompus et verrous APT
  shell: |
    rm -f /tmp/cri-dockerd.deb
    rm -f /var/lib/dpkg/lock-frontend
    apt-get clean
    apt-get install -f -y
  ignore_errors: yes

# 2. Préparation Système et Dépendances
# -------------------------------------------------------------------------
- name: Installer les dépendances APT de base
  apt:
    name: [ 'apt-transport-https', 'ca-certificates', 'curl', 'gnupg', 'docker.io', 'containerd', 'runc' ]
    state: present
    update_cache: yes

- name: Créer le dossier pour la clé du dépôt K8s
  file:
    path: /etc/apt/keyrings
    state: directory
    mode: '0755'

- name: Configurer le dépôt Kubernetes v1.28
  shell: |
    curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.28/deb/Release.key | gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
    echo "deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.28/deb/ /" > /etc/apt/sources.list.d/kubernetes.list

# 3. Installation de cri-dockerd (Le connecteur Docker)
# -------------------------------------------------------------------------
- name: Télécharger cri-dockerd (Force download pour éviter corruption)
  get_url:
    url: https://github.com/Mirantis/cri-dockerd/releases/download/v0.3.4/cri-dockerd_0.3.4.3-0.ubuntu-jammy_amd64.deb
    dest: /tmp/cri-dockerd.deb
    force: yes

- name: Installer cri-dockerd
  apt:
    deb: /tmp/cri-dockerd.deb

- name: Debug - Vérifier l'état du socket cri-dockerd
  command: ls -la /var/run/cri-dockerd.sock
  register: socket_check
  ignore_errors: yes

- debug:
    var: socket_check.stdout

# 4. Installation des binaires K8s
# -------------------------------------------------------------------------
- name: Installer kubeadm, kubelet et kubectl
  apt:
    name: [ 'kubelet', 'kubeadm', 'kubectl' ]
    state: present
    update_cache: yes

- name: Fixer les versions (Hold)
  dpkg_selections:
    name: "{{ item }}"
    selection: hold
  loop: [ 'kubelet', 'kubeadm', 'kubectl' ]

# 5. Initialisation (Master uniquement)
# -------------------------------------------------------------------------
- name: Initialiser le Master
  command: >
    kubeadm init --pod-network-cidr=192.168.0.0/16
    --token={{ token }}
    --cri-socket unix:///var/run/cri-dockerd.sock
    --ignore-preflight-errors=all
  args:
    creates: /etc/kubernetes/admin.conf
  when: node_role == "master"
  register: kubeinit_output

- debug:
    var: kubeinit_output.stdout_lines
  when: node_role == "master" and kubeinit_output.changed

- name: Configurer Kubeconfig pour l'utilisateur ubuntu
  shell: |
    mkdir -p /home/ubuntu/.kube
    cp /etc/kubernetes/admin.conf /home/ubuntu/.kube/config
    chown ubuntu:ubuntu /home/ubuntu/.kube/config
  when: node_role == "master"

# 6. Réseau Calico (Master uniquement)
# -------------------------------------------------------------------------
- name: Installer Calico
  become: yes
  become_user: ubuntu
  shell: |
    kubectl create -f https://raw.githubusercontent.com/projectcalico/calico/v3.27.0/manifests/tigera-operator.yaml
    sleep 5
    kubectl create -f https://raw.githubusercontent.com/projectcalico/calico/v3.27.0/manifests/custom-resources.yaml
  when: node_role == "master"
  ignore_errors: yes

# 7. Jointure (Worker uniquement)
# -------------------------------------------------------------------------
- name: Joindre le Cluster
  command: >
    kubeadm join {{ master_ip }}:6443
    --token={{ token }}
    --discovery-token-unsafe-skip-ca-verification
    --cri-socket unix:///var/run/cri-dockerd.sock
  args:
    creates: /etc/kubernetes/kubelet.conf
  when: node_role == "worker"
  register: join_output

- debug:
    var: join_output.stdout
  when: node_role == "worker"
