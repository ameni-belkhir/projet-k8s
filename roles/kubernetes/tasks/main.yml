
Vous avez envoyÃ©
---
# ==================== RÃ‰CUPÃ‰RER LES VARIABLES D'ENVIRONNEMENT ====================
- name: RÃ©cupÃ©rer les variables d'environnement
  set_fact:
    node_role: "{{ lookup('env', 'NODE_ROLE') | default(node_role | default('')) }}"
    master_ip: "{{ lookup('env', 'MASTER_IP') | default(master_ip | default('')) }}"
    token: "{{ lookup('env', 'TOKEN') | default('abcdef.1234567890abcdef') }}"

- name: Afficher la configuration
  debug:
    msg: "Configuration - RÃ´le: {{ node_role }}, Master IP: {{ master_ip }}"

# ==================== TÃ‚CHES COMMUNES (Master & Worker) ====================
- name: "ðŸ”§ TÃ‚CHES COMMUNES - ExÃ©cution sur {{ node_role }}"
  block:
    # 1. Protection contre les verrous APT & RÃ©parations
    - name: Attendre que le verrou APT soit libÃ©rÃ©
      shell: while fuser /var/lib/dpkg/lock-frontend >/dev/null 2>&1; do sleep 5; done;
      changed_when: false

    - name: RÃ©parer les installations de paquets interrompues
      shell: |
        dpkg --configure -a
        apt-get install -f -y
      ignore_errors: yes

    # 2. PrÃ©paration du SystÃ¨me (Swap, Modules, RÃ©seau)
    - name: Supprimer les anciens dÃ©pÃ´ts Kubernetes
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - /etc/apt/sources.list.d/kubernetes.list
        - /etc/apt/keyrings/kubernetes-apt-keyring.asc

    - name: DÃ©sactiver le Swap
      shell: |
        swapoff -a
        sed -i '/\sswap\s/ s/^\(.*\)$/#\1/g' /etc/fstab
      when: ansible_swaptotal_mb > 0

    - name: Charger les modules noyau
      modprobe:
        name: "{{ item }}"
        state: present
      loop: [overlay, br_netfilter]

    - name: Configurer le sysctl pour le rÃ©seau
      sysctl:
        name: "{{ item.key }}"
        value: "{{ item.value }}"
        state: present
        reload: yes
      loop:
        - { key: 'net.bridge.bridge-nf-call-iptables', value: '1' }
        - { key: 'net.ipv4.ip_forward', value: '1' }

    # 3. Installation des DÃ©pendances & CRI-Dockerd
    - name: CrÃ©er le rÃ©pertoire keyrings
      file:
        path: /etc/apt/keyrings
        state: directory
        mode: '0755'

    - name: Configurer le dÃ©pÃ´t Kubernetes (v1.29)
      shell: |
        curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.29/deb/Release.key | gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg --yes
        echo "deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.29/deb/ /" > /etc/apt/sources.list.d/kubernetes.list

    - name: Installer Docker et les outils K8s
      apt:
        name: [docker.io, kubelet, kubeadm, kubectl]
        state: present
        update_cache: yes

    - name: Configurer Docker (Cgroup systemd)
      copy:
        dest: /etc/docker/daemon.json
        content: |
          {
            "exec-opts": ["native.cgroupdriver=systemd"],
            "log-driver": "json-file",
            "storage-driver": "overlay2"
          }

    - name: Installer et dÃ©marrer cri-dockerd
      block:
        - name: Supprimer tout ancien fichier corrompu
          file:
            path: /tmp/cri-dockerd.deb
            state: absent

        - name: TÃ©lÃ©charger cri-dockerd (v0.3.11)
          get_url:
            url: "https://github.com/Mirantis/cri-dockerd/releases/download/v0.3.11/cri-dockerd_0.3.11.3-0.ubuntu-jammy_amd64.deb"
            dest: /tmp/cri-dockerd.deb
            mode: '0644'
            force: yes  # Force le retÃ©lÃ©chargement pour garantir l'intÃ©gritÃ©
            timeout: 60

        - name: Installer le paquet .deb
          apt:
            deb: /tmp/cri-dockerd.deb
            state: present

        - name: RedÃ©marrer les services
          systemd:
            name: "{{ item }}"
            state: restarted
            enabled: yes
            daemon_reload: yes
          loop: [docker, cri-docker]
  when: node_role in ["master", "worker"]

# ==================== TÃ‚CHES SPÃ‰CIFIQUES AU MASTER ====================
- name: "ðŸ‘‘ TÃ‚CHES MASTER - Initialisation du cluster"
  when: node_role == "master"
  block:
    - name: Initialiser le Master Kubernetes
      command: >
        kubeadm init --pod-network-cidr=192.168.0.0/16 
        --token={{ token }} 
        --cri-socket unix:///var/run/cri-dockerd.sock 
        --ignore-preflight-errors=all
      args:
        creates: /etc/kubernetes/admin.conf

    - name: Configurer Kubeconfig pour l'utilisateur ubuntu
      block:
        - name: CrÃ©er le dossier .kube
          file:
            path: /home/ubuntu/.kube
            state: directory
            owner: ubuntu
            group: ubuntu
        - name: Copier admin.conf
          copy:
            src: /etc/kubernetes/admin.conf
            dest: /home/ubuntu/.kube/config
            remote_src: yes
            owner: ubuntu
            group: ubuntu
            mode: '0600'

# ==================== TÃ‚CHES SPÃ‰CIFIQUES AU WORKER ====================
- name: "ðŸ”§ TÃ‚CHES WORKER - Join au cluster"
  when: node_role == "worker"
  block:
    - name: VÃ©rifier que l'IP du master est fournie
      fail:
        msg: "La variable d'environnement MASTER_IP doit Ãªtre dÃ©finie pour les workers"
      when: master_ip == ""

    - name: Attendre que le master soit prÃªt (port 6443)
      wait_for:
        host: "{{ master_ip }}"
        port: 6443
        delay: 10
        timeout: 300
        state: started

    - name: Joindre le Worker au Cluster
      command: >
        kubeadm join {{ master_ip }}:6443 
        --token={{ token }} 
        --discovery-token-unsafe-skip-ca-verification 
        --cri-socket unix:///var/run/cri-dockerd.sock
      args:
        creates: /etc/kubernetes/kubelet.conf
