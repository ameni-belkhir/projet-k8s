# Kubernetes Role - Main Tasks
# Handles both master and worker node setup with comprehensive error handling

- name: Wait for apt locks to be released
  shell: |
    while fuser /var/lib/dpkg/lock-frontend >/dev/null 2>&1 || \
          fuser /var/lib/dpkg/lock >/dev/null 2>&1 || \
          fuser /var/lib/apt/lists/lock >/dev/null 2>&1 || \
          fuser /var/cache/apt/archives/lock >/dev/null 2>&1; do
      echo "Waiting for apt locks..."
      sleep 5
    done
  changed_when: false

- name: Fix interrupted dpkg installations
  shell: |
    dpkg --configure -a
    apt-get install -f -y
  ignore_errors: yes
  changed_when: false

- name: Disable swap immediately
  shell: swapoff -a
  when: ansible_swaptotal_mb > 0
  changed_when: false

- name: Disable swap permanently in fstab
  replace:
    path: /etc/fstab
    regexp: '^([^#].*?\sswap\s+.*)$'
    replace: '# \1'
  when: ansible_swaptotal_mb > 0

- name: Load required kernel modules
  modprobe:
    name: "{{ item }}"
    state: present
  loop:
    - overlay
    - br_netfilter

- name: Persist kernel modules on boot
  copy:
    dest: /etc/modules-load.d/k8s.conf
    content: |
      overlay
      br_netfilter

- name: Configure sysctl for Kubernetes networking
  sysctl:
    name: "{{ item.key }}"
    value: "{{ item.value }}"
    state: present
    reload: yes
    sysctl_file: /etc/sysctl.d/k8s.conf
  loop:
    - { key: 'net.bridge.bridge-nf-call-iptables', value: '1' }
    - { key: 'net.bridge.bridge-nf-call-ip6tables', value: '1' }
    - { key: 'net.ipv4.ip_forward', value: '1' }

- name: Create apt keyrings directory
  file:
    path: /etc/apt/keyrings
    state: directory
    mode: '0755'

- name: Add Kubernetes apt signing key
  shell: |
    curl -fsSL https://pkgs.k8s.io/core:/stable:/v{{ k8s_version }}/deb/Release.key | \
    gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg --yes
  args:
    creates: /etc/apt/keyrings/kubernetes-apt-keyring.gpg

- name: Add Kubernetes apt repository
  copy:
    dest: /etc/apt/sources.list.d/kubernetes.list
    content: |
      deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v{{ k8s_version }}/deb/ /

- name: Update apt cache
  apt:
    update_cache: yes
  retries: 10
  delay: 10
  register: apt_update_result
  until: apt_update_result is succeeded

- name: Install Docker and container runtime dependencies
  apt:
    name:
      - apt-transport-https
      - ca-certificates
      - curl
      - gnupg
      - lsb-release
      - docker.io
      - containerd
    state: present
  retries: 10
  delay: 10

- name: Install Kubernetes packages
  apt:
    name:
      - "kubelet={{ k8s_version }}.*"
      - "kubeadm={{ k8s_version }}.*"
      - "kubectl={{ k8s_version }}.*"
    state: present
  retries: 10
  delay: 10

- name: Hold Kubernetes packages
  dpkg_selections:
    name: "{{ item }}"
    selection: hold
  loop:
    - kubelet
    - kubeadm
    - kubectl

- name: Configure Docker daemon (systemd cgroup driver)
  copy:
    dest: /etc/docker/daemon.json
    content: |
      {
        "exec-opts": ["native.cgroupdriver=systemd"],
        "log-driver": "json-file",
        "log-opts": { "max-size": "100m", "max-file": "3" },
        "storage-driver": "overlay2"
      }
  notify: restart docker

- name: Ensure Docker service is enabled and started
  systemd:
    name: docker
    state: started
    enabled: yes

- name: Download cri-dockerd package
  get_url:
    url: "https://github.com/Mirantis/cri-dockerd/releases/download/v0.3.10/cri-dockerd_0.3.10.3-0.ubuntu-jammy_amd64.deb"
    dest: /tmp/cri-dockerd.deb
    mode: '0644'
    checksum: "sha256:5a9f09f807ca38a4970396dd23f6919b9d4930b4"
    force: yes
  retries: 10
  delay: 10

- name: Install cri-dockerd
  apt:
    deb: /tmp/cri-dockerd.deb
    state: present

- name: Ensure cri-docker service is running
  systemd:
    name: "{{ item }}"
    state: started
    enabled: yes
  loop:
    - cri-docker.service
    - cri-docker.socket

# ===== MASTER NODE TASKS =====
- name: Check if Kubernetes is already initialized
  stat:
    path: /etc/kubernetes/admin.conf
  register: kubeadm_init_check
  when: node_role == 'master'

- name: Initialize Kubernetes master
  command: >
    kubeadm init
    --pod-network-cidr={{ pod_network_cidr }}
    --token={{ token }}
    --token-ttl=0
    --cri-socket=unix:///var/run/cri-dockerd.sock
    --ignore-preflight-errors=NumCPU,Mem
  when: 
    - node_role == 'master'
    - not kubeadm_init_check.stat.exists
  register: kubeadm_init_output

- name: Setup kubeconfig for ubuntu user
  file:
    path: "/home/ubuntu/.kube"
    state: directory
    owner: ubuntu
    group: ubuntu
    mode: '0755'
  when: node_role == 'master'

- name: Copy admin.conf to ubuntu user
  copy:
    src: /etc/kubernetes/admin.conf
    dest: /home/ubuntu/.kube/config
    remote_src: yes
    owner: ubuntu
    group: ubuntu
    mode: '0600'
  when: node_role == 'master'

# ===== NETWORKING (CALICO) =====
- name: Install Calico Tigera Operator
  become: yes
  become_user: ubuntu
  shell: |
    kubectl apply -f https://raw.githubusercontent.com/projectcalico/calico/{{ calico_version }}/manifests/tigera-operator.yaml
  environment:
    KUBECONFIG: /home/ubuntu/.kube/config
  when: node_role == 'master'
  retries: 10
  delay: 15

- name: Apply Calico custom resources
  become: yes
  become_user: ubuntu
  shell: |
    cat <<EOF | kubectl apply -f -
    apiVersion: operator.tigera.io/v1
    kind: Installation
    metadata:
      name: default
    spec:
      calicoNetwork:
        ipPools:
        - blockSize: 26
          cidr: {{ pod_network_cidr }}
          encapsulation: VXLANCrossSubnet
          natOutgoing: Enabled
          nodeSelector: all()
    ---
    apiVersion: operator.tigera.io/v1
    kind: APIServer
    metadata:
      name: default
    spec: {}
    EOF
  environment:
    KUBECONFIG: /home/ubuntu/.kube/config
  when: node_role == 'master'

# ===== WORKER NODE TASKS =====
- name: Check if node joined
  stat:
    path: /etc/kubernetes/kubelet.conf
  register: kubelet_conf_check
  when: node_role == 'worker'

- name: Join worker node
  command: >
    kubeadm join {{ master_ip }}:6443
    --token={{ token }}
    --discovery-token-unsafe-skip-ca-verification
    --cri-socket=unix:///var/run/cri-dockerd.sock
  when:
    - node_role == 'worker'
    - not kubelet_conf_check.stat.exists
  retries: 10
  delay: 30
