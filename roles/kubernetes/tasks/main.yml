---
# 1. Configuration Système (Prérequis indispensables)
# -------------------------------------------------------------------------
- name: Résoudre le hostname localement
  lineinfile:
    path: /etc/hosts
    line: "127.0.0.1 {{ ansible_hostname }} k8s-master"
    state: present

- name: Charger les modules noyau pour Kubernetes
  shell: |
    modprobe overlay
    modprobe br_netfilter

- name: Configurer les paramètres réseau (sysctl)
  copy:
    dest: /etc/sysctl.d/k8s.conf
    content: |
      net.bridge.bridge-nf-call-iptables  = 1
      net.bridge.bridge-nf-call-ip6tables = 1
      net.ipv4.ip_forward                 = 1

- name: Appliquer les modifications sysctl
  command: sysctl --system

# 2. Installation de Docker et Containerd (CRI Base)
# -------------------------------------------------------------------------
- name: Installer Docker.io et Containerd
  apt:
    name: [ 'docker.io', 'containerd', 'curl', 'gnupg', 'apt-transport-https' ]
    state: present
    update_cache: yes

- name: Activer et démarrer Docker
  systemd:
    name: docker
    state: started
    enabled: yes

# 3. Installation de cri-dockerd (Le pont entre Docker et K8s)
# -------------------------------------------------------------------------
- name: Télécharger le paquet cri-dockerd
  get_url:
    url: https://github.com/Mirantis/cri-dockerd/releases/download/v0.3.4/cri-dockerd_0.3.4.3-0.ubuntu-jammy_amd64.deb
    dest: /tmp/cri-dockerd.deb

- name: Installer cri-dockerd (résout les dépendances automatiques)
  apt:
    deb: /tmp/cri-dockerd.deb

- name: Activer et démarrer le service cri-docker
  systemd:
    name: cri-docker
    state: started
    enabled: yes

# 4. Installation des dépôts et binaires Kubernetes
# -------------------------------------------------------------------------
- name: Créer le dossier des clés APT
  file:
    path: /etc/apt/keyrings
    state: directory
    mode: '0755'

- name: Ajouter la clé GPG officielle Kubernetes
  shell: |
    curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.28/deb/Release.key | gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
  args:
    creates: /etc/apt/keyrings/kubernetes-apt-keyring.gpg

- name: Ajouter le dépôt Kubernetes (v1.28)
  copy:
    dest: /etc/apt/sources.list.d/kubernetes.list
    content: "deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.28/deb/ /"

- name: Installer Kubeadm, Kubelet et Kubectl
  apt:
    name: [ 'kubelet', 'kubeadm', 'kubectl' ]
    state: present
    update_cache: yes

- name: Bloquer la version des paquets
  dpkg_selections:
    name: "{{ item }}"
    selection: hold
  loop: [ 'kubelet', 'kubeadm', 'kubectl' ]

# 5. Initialisation du Master (Uniquement sur le Master)
# -------------------------------------------------------------------------
- name: Nettoyer les résidus CNI avant init
  file:
    path: /etc/cni/net.d
    state: absent
  when: node_role == "master"

- name: Initialiser le cluster avec kubeadm
  command: >
    kubeadm init --pod-network-cidr=192.168.0.0/16
    --token={{ token }}
    --cri-socket unix:///var/run/cri-dockerd.sock
    --ignore-preflight-errors=all
  args:
    creates: /etc/kubernetes/admin.conf
  when: node_role == "master"

- name: Configurer Kubeconfig pour l'utilisateur ubuntu
  shell: |
    mkdir -p /home/ubuntu/.kube
    cp /etc/kubernetes/admin.conf /home/ubuntu/.kube/config
    chown ubuntu:ubuntu /home/ubuntu/.kube/config
  when: node_role == "master"

# 6. Installation du réseau Calico (Uniquement sur le Master)
# -------------------------------------------------------------------------
- name: Déployer Calico via l'Opérateur
  become: yes
  become_user: ubuntu
  shell: |
    kubectl create -f https://raw.githubusercontent.com/projectcalico/calico/v3.27.0/manifests/tigera-operator.yaml
    sleep 10
    kubectl create -f https://raw.githubusercontent.com/projectcalico/calico/v3.27.0/manifests/custom-resources.yaml
  when: node_role == "master"
  ignore_errors: yes

# 7. Jointure des Workers (Uniquement sur les Workers)
# -------------------------------------------------------------------------
- name: Rejoindre le cluster Kubernetes
  command: >
    kubeadm join {{ master_ip }}:6443
    --token={{ token }}
    --discovery-token-unsafe-skip-ca-verification
    --cri-socket unix:///var/run/cri-dockerd.sock
  args:
    creates: /etc/kubernetes/kubelet.conf
  when: node_role == "worker"
