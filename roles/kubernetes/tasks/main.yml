---
# 1. Désactivation du Swap (obligatoire pour K8s)
- name: Désactiver le swap immédiatement
  command: swapoff -a

- name: Supprimer le swap du fichier fstab
  replace:
    path: /etc/fstab
    regexp: '^([^#].*?\sswap\s+.*)$'
    replace: '# \1'

# 2. Configuration du réseau (Modules Kernel)
- name: Charger les modules bridge et overlay
  modprobe:
    name: "{{ item }}"
    state: present
  loop: [ 'overlay', 'br_netfilter' ]

- name: Configurer les paramètres sysctl pour le réseau
  sysctl:
    name: "{{ item.key }}"
    value: "{{ item.value }}"
    state: present
  loop:
    - { key: 'net.bridge.bridge-nf-call-iptables', value: '1' }
    - { key: 'net.bridge.bridge-nf-call-ip6tables', value: '1' }
    - { key: 'net.ipv4.ip_forward', value: '1' }

# 3. Installation du runtime (Docker/Containerd)
- name: Installer Docker
  apt:
    name: docker.io
    state: present
    update_cache: yes

# 4. Installation des outils K8s (Nouvelle méthode officielle)
- name: Créer le dossier pour la clé de dépôt
  file:
    path: /etc/apt/keyrings
    state: directory
    mode: '0755'

- name: Télécharger la clé GPG du dépôt K8s
  get_url:
    url: https://pkgs.k8s.io/core:/stable:/v1.29/deb/Release.key
    dest: /etc/apt/keyrings/kubernetes-apt-keyring.asc
    mode: '0644'

- name: Ajouter le dépôt Kubernetes (v1.29)
  apt_repository:
    repo: "deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.asc] https://pkgs.k8s.io/core:/stable:/v1.29/deb/ /"
    state: present
    filename: kubernetes

- name: Installer les composants Kubernetes
  apt:
    name: [kubelet, kubeadm, kubectl]
    state: present
    update_cache: yes
