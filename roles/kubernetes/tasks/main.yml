---
# A. Configuration Système (Prérequis réseau et Hostname)
# -------------------------------------------------------------------------
- name: Ajouter le hostname dans /etc/hosts pour la résolution locale
  lineinfile:
    path: /etc/hosts
    line: "127.0.0.1 {{ ansible_hostname }}"
    state: present

- name: Charger les modules du noyau pour Kubernetes
  shell: |
    modprobe overlay
    modprobe br_netfilter

- name: Configurer les paramètres sysctl pour le réseau K8s
  copy:
    dest: /etc/sysctl.d/k8s.conf
    content: |
      net.bridge.bridge-nf-call-iptables  = 1
      net.bridge.bridge-nf-call-ip6tables = 1
      net.ipv4.ip_forward                 = 1

- name: Appliquer les paramètres sysctl
  command: sysctl --system

# B. Installation de cri-dockerd (Le lien entre Docker et K8s)
# -------------------------------------------------------------------------
- name: Télécharger et installer cri-dockerd (version 0.3.4 pour Ubuntu Jammy)
  shell: |
    wget https://github.com/Mirantis/cri-dockerd/releases/download/v0.3.4/cri-dockerd_0.3.4.3-0.ubuntu-jammy_amd64.deb
    dpkg -i cri-dockerd_0.3.4.3-0.ubuntu-jammy_amd64.deb
  args:
    creates: /usr/bin/cri-dockerd

- name: Activer et démarrer le service cri-docker
  systemd:
    name: cri-docker
    state: started
    enabled: yes

# C. Installation des dépôts et binaires K8s
# -------------------------------------------------------------------------
- name: Installer les dépendances APT
  apt:
    name: [ 'apt-transport-https', 'ca-certificates', 'curl', 'gnupg' ]
    state: present
    update_cache: yes

- name: Créer le dossier pour la clé du dépôt K8s
  file:
    path: /etc/apt/keyrings
    state: directory
    mode: '0755'

- name: Ajouter la clé GPG de Kubernetes
  shell: |
    curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.28/deb/Release.key | gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
  args:
    creates: /etc/apt/keyrings/kubernetes-apt-keyring.gpg

- name: Ajouter le dépôt APT de Kubernetes (v1.28)
  copy:
    dest: /etc/apt/sources.list.d/kubernetes.list
    content: "deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.28/deb/ /"

- name: Installer kubeadm, kubelet et kubectl
  apt:
    name: [ 'kubelet', 'kubeadm', 'kubectl' ]
    state: present
    update_cache: yes

- name: Bloquer les versions des binaires K8s
  dpkg_selections:
    name: "{{ item }}"
    selection: hold
  loop: [ 'kubelet', 'kubeadm', 'kubectl' ]

# D. Nettoyage Final avant Init
# -------------------------------------------------------------------------
- name: Nettoyer les résidus CNI et attendre les verrous APT
  shell: |
    rm -rf /etc/cni/net.d/*
    while fuser /var/lib/dpkg/lock-frontend >/dev/null 2>&1; do sleep 5; done;
  ignore_errors: yes

# E. Initialisation (Master uniquement)
# -------------------------------------------------------------------------
- name: Initialiser le Master
  command: >
    kubeadm init --pod-network-cidr=192.168.0.0/16
    --token={{ token }}
    --cri-socket unix:///var/run/cri-dockerd.sock
    --ignore-preflight-errors=all
  args:
    creates: /etc/kubernetes/admin.conf
  when: node_role == "master"

- name: Configurer Kubeconfig pour l'utilisateur ubuntu
  shell: |
    mkdir -p /home/ubuntu/.kube
    cp /etc/kubernetes/admin.conf /home/ubuntu/.kube/config
    chown ubuntu:ubuntu /home/ubuntu/.kube/config
  when: node_role == "master"

# F. Réseau Calico (Master uniquement)
# -------------------------------------------------------------------------
- name: Installer Calico via l'Opérateur
  become: yes
  become_user: ubuntu
  shell: |
    kubectl create -f https://raw.githubusercontent.com/projectcalico/calico/v3.27.0/manifests/tigera-operator.yaml
    sleep 10
    kubectl create -f https://raw.githubusercontent.com/projectcalico/calico/v3.27.0/manifests/custom-resources.yaml
  when: node_role == "master"
  ignore_errors: yes

# G. Jointure (Worker uniquement)
# -------------------------------------------------------------------------
- name: Joindre le Cluster
  command: >
    kubeadm join {{ master_ip }}:6443
    --token={{ token }}
    --discovery-token-unsafe-skip-ca-verification
    --cri-socket unix:///var/run/cri-dockerd.sock
  args:
    creates: /etc/kubernetes/kubelet.conf
  when: node_role == "worker"
