---
# 1. Préparation Système
- name: Supprimer anciens dépôts
  file:
    path: "{{ item }}"
    state: absent
  loop:
    - /etc/apt/sources.list.d/kubernetes.list
    - /etc/apt/keyrings/kubernetes-apt-keyring.asc

- name: Désactiver le swap
  command: swapoff -a
  when: ansible_swaptotal_mb > 0

- name: Charger les modules noyau nécessaires
  modprobe:
    name: "{{ item }}"
    state: present
  loop:
    - overlay
    - br_netfilter

- name: Configuration sysctl réseau
  sysctl:
    name: "{{ item.key }}"
    value: "{{ item.value }}"
    state: present
    reload: yes
    sysctl_file: /etc/sysctl.d/k8s.conf
  loop:
    - { key: 'net.bridge.bridge-nf-call-iptables', value: '1' }
    - { key: 'net.ipv4.ip_forward', value: '1' }

# 2. Installation Composants
- name: Installer Docker et Outils K8s
  apt:
    name: [docker.io, kubelet, kubeadm, kubectl]
    state: present
    update_cache: yes

# 3. Logique MASTER
- name: Initialiser le Master Kubernetes (CIDR Calico)
  command: kubeadm init --pod-network-cidr=192.168.0.0/16 --token=abcdef.1234567890abcdef12 --ignore-preflight-errors=all
  register: kubeadm_init
  retries: 3
  delay: 30
  until: kubeadm_init is succeeded
  when: "'master' in ansible_hostname"
  args:
    creates: /etc/kubernetes/admin.conf

- name: Créer le répertoire .kube
  file:
    path: /home/ubuntu/.kube
    state: directory
    owner: ubuntu
    group: ubuntu
    mode: '0755'
  when: "'master' in ansible_hostname"

- name: Configurer kubectl
  copy:
    src: /etc/kubernetes/admin.conf
    dest: /home/ubuntu/.kube/config
    remote_src: yes
    owner: ubuntu
    group: ubuntu
    mode: '0600'
  when: "'master' in ansible_hostname"

- name: Attendre que l'API Server (6443) soit prêt
  wait_for:
    port: 6443
    delay: 15
    timeout: 300
  when: "'master' in ansible_hostname"

- name: Installer l'Operator Tigera (Calico)
  become: yes
  become_user: ubuntu
  command: kubectl create -f https://raw.githubusercontent.com/projectcalico/calico/v3.27.0/manifests/tigera-operator.yaml --validate=false
  register: tigera_res
  retries: 5
  delay: 20
  until: tigera_res is succeeded
  when: "'master' in ansible_hostname"

- name: Installer les ressources Calico
  become: yes
  become_user: ubuntu
  command: kubectl create -f https://raw.githubusercontent.com/projectcalico/calico/v3.27.0/manifests/custom-resources.yaml --validate=false
  register: calico_res
  retries: 5
  delay: 20
  until: calico_res is succeeded
  when: "'master' in ansible_hostname"

# 4. Logique WORKER
- name: Rejoindre le cluster automatiquement
  command: kubeadm join 172.16.1.128:6443 --token=abcdef.1234567890abcdef12 --discovery-token-unsafe-skip-ca-verification
  register: worker_join
  retries: 5
  delay: 30
  until: worker_join is succeeded
  args:
    creates: /etc/kubernetes/kubelet.conf
  when: "'worker' in ansible_hostname"
