---
# ==================== R√âCUP√âRER LE R√îLE ====================
- name: R√©cup√©rer le r√¥le depuis l'environnement
  set_fact:
    node_role: "{{ lookup('env', 'NODE_ROLE') | default(node_role | default('')) }}"
    master_ip: "{{ lookup('env', 'MASTER_IP') | default(master_ip | default('')) }}"

# ==================== CALICO NETWORK (Master seulement) ====================
- name: "üì¶ Installation de Calico Network (Master seulement)"
  when: node_role == "master"
  block:
    - name: Configurer les permissions sur admin.conf pour l'utilisateur ubuntu
      file:
        path: /etc/kubernetes/admin.conf
        mode: '0644'

    # V√©rifier si Calico est d√©j√† install√© (optionnel mais bonne pratique)
    - name: V√©rifier si Calico est d√©j√† d√©ploy√©
      become: yes
      become_user: ubuntu
      shell: kubectl get namespace calico-system --ignore-not-found -o name
      register: calico_namespace
      changed_when: false
      failed_when: false

    - name: Installer l'op√©rateur Tigera Calico (idempotent avec apply)
      become: yes
      become_user: ubuntu
      shell: |
        kubectl apply -f https://raw.githubusercontent.com/projectcalico/calico/v3.27.0/manifests/tigera-operator.yaml
      register: tigera_install
      until: tigera_install.rc == 0
      retries: 3
      delay: 10
      when: calico_namespace.stdout == ""  # Ne pas r√©installer si d√©j√† pr√©sent

    - name: Attendre que l'op√©rateur Calico soit pr√™t
      become: yes
      become_user: ubuntu
      shell: |
        kubectl wait --namespace tigera-operator \
          --for=condition=ready pod \
          --selector name=tigera-operator \
          --timeout=120s
      register: operator_ready
      until: operator_ready.rc == 0
      retries: 5
      delay: 10
      ignore_errors: yes  # On continue m√™me si timeout, mais on log

    - name: Cr√©er le fichier de configuration Calico
      copy:
        dest: /home/ubuntu/custom-resources.yaml
        content: |
          apiVersion: operator.tigera.io/v1
          kind: Installation
          metadata:
            name: default
          spec:
            calicoNetwork:
              ipPools:
              - blockSize: 26
                cidr: 192.168.0.0/16
                encapsulation: VXLANCrossSubnet
                natOutgoing: Enabled
                nodeSelector: all()
          ---
          apiVersion: operator.tigera.io/v1
          kind: APIServer
          metadata:
            name: default
          spec: {}
        owner: ubuntu
        group: ubuntu

    - name: Appliquer la configuration Calico
      become: yes
      become_user: ubuntu
      shell: |
        kubectl apply -f /home/ubuntu/custom-resources.yaml
      register: calico_apply

    - name: Attendre que les pods Calico soient pr√™ts (Crucial avant Helm)
      become: yes
      become_user: ubuntu
      shell: |
        kubectl wait --namespace calico-system --for=condition=ready pod --all --timeout=300s
      register: calico_ready
      until: calico_ready.rc == 0
      retries: 3
      delay: 20
      ignore_errors: yes

    # Optionnel : attendre que les n≈ìuds soient pr√™ts
    - name: Attendre que tous les n≈ìuds soient Ready
      become: yes
      become_user: ubuntu
      shell: |
        kubectl wait --for=condition=Ready nodes --all --timeout=300s
      register: nodes_ready
      until: nodes_ready.rc == 0
      retries: 3
      delay: 20
      ignore_errors: yes

# ==================== PROMETHEUS/GRAFANA (Master seulement) ====================
- name: "üìä Installation de Prometheus Stack (Master seulement)"
  when: node_role == "master"
  block:
    # Installation robuste de Helm (binaire)
    - name: V√©rifier si Helm est d√©j√† install√©
      command: which helm
      register: helm_exists
      changed_when: false
      failed_when: false

    - name: T√©l√©charger et installer Helm si absent
      when: helm_exists.rc != 0
      block:
        - name: T√©l√©charger le script d'installation Helm
          get_url:
            url: https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3
            dest: /tmp/get_helm.sh
            mode: '0755'
        - name: Ex√©cuter le script d'installation
          shell: /tmp/get_helm.sh
          args:
            creates: /usr/local/bin/helm

    - name: Ajouter le repo Helm Prometheus
      become: yes
      become_user: ubuntu
      shell: |
        helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
        helm repo update
      register: helm_repo
      changed_when: "'prometheus-community' not in helm_repo.stdout"  # Idempotence approximative
      retries: 3
      delay: 5

    - name: Cr√©er le fichier de valeurs Prometheus
      copy:
        dest: /home/ubuntu/prometheus-values.yaml
        content: |
          prometheus:
            prometheusSpec:
              retention: 3d
              storageSpec:
                emptyDir: {}
          grafana:
            adminPassword: "admin"
            persistence:
              enabled: false
            service:
              type: NodePort
              nodePort: 30300
        owner: ubuntu
        group: ubuntu

    - name: V√©rifier si Prometheus est d√©j√† install√©
      become: yes
      become_user: ubuntu
      shell: |
        helm list -n monitoring | grep prometheus || true
      register: prometheus_installed
      changed_when: false

    - name: Installer la stack Prometheus via Helm (idempotent)
      become: yes
      become_user: ubuntu
      shell: |
        helm upgrade --install prometheus prometheus-community/kube-prometheus-stack \
          --namespace monitoring \
          --create-namespace \
          --values /home/ubuntu/prometheus-values.yaml \
          --wait --timeout 10m
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf
      when: "'prometheus' not in prometheus_installed.stdout"
      register: helm_install
      retries: 2
      delay: 10

    # Essayer de r√©cup√©rer l'IP publique du master (si disponible via metadata OpenStack)
    - name: R√©cup√©rer l'IP publique depuis l'API metadata (si disponible)
      uri:
        url: http://169.254.169.254/latest/meta-data/public-ipv4
        method: GET
        timeout: 5
      register: public_ip
      ignore_errors: yes
      changed_when: false

    - name: Afficher les informations d'acc√®s
      debug:
        msg:
          - "=========================================="
          - "‚úÖ Cluster K8s et Monitoring op√©rationnels"
          - "üìä Grafana: http://{{ public_ip.content | default(ansible_default_ipv4.address | default('<IP_PUBLIQUE>')) }}:30300"
          - "üë§ Utilisateur: admin / Mot de passe: admin"
          - "‚ÑπÔ∏è  Si l'IP ci-dessus n'est pas accessible depuis l'ext√©rieur, utilisez l'IP flottante du master fournie par Heat."
          - "=========================================="
