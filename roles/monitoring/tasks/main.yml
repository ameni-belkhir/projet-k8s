---
# ==================== R√âCUP√âRER LE R√îLE ====================
- name: R√©cup√©rer le r√¥le depuis l'environnement
  set_fact:
    node_role: "{{ lookup('env', 'NODE_ROLE') }}"
    master_ip: "{{ lookup('env', 'MASTER_IP') | default('') }}"

# ==================== CALICO NETWORK (Master seulement) ====================
- name: "üì¶ Installation de Calico Network (Master seulement)"
  when: node_role == "master"
  block:
    - name: Installer l'op√©rateur Tigera Calico
      become: yes
      become_user: ubuntu
      shell: |
        kubectl create -f https://raw.githubusercontent.com/projectcalico/calico/v3.27.0/manifests/tigera-operator.yaml
      register: tigera_install
      until: tigera_install.rc == 0
      retries: 3
      delay: 10
      ignore_errors: yes

    - name: Attendre que l'op√©rateur Calico soit pr√™t
      become: yes
      become_user: ubuntu
      shell: |
        kubectl wait --namespace tigera-operator \
          --for=condition=ready pod \
          --selector name=tigera-operator \
          --timeout=120s
      register: operator_ready
      retries: 5
      delay: 10
      until: operator_ready.rc == 0
      ignore_errors: yes

    - name: Cr√©er le fichier de configuration Calico
      become: yes
      copy:
        dest: /home/ubuntu/custom-resources.yaml
        content: |
          apiVersion: operator.tigera.io/v1
          kind: Installation
          metadata:
            name: default
          spec:
            calicoNetwork:
              ipPools:
              - blockSize: 26
                cidr: 192.168.0.0/16
                encapsulation: VXLANCrossSubnet
                natOutgoing: Enabled
                nodeSelector: all()
          ---
          apiVersion: operator.tigera.io/v1
          kind: APIServer
          metadata:
            name: default
          spec: {}
        owner: ubuntu
        group: ubuntu

    - name: Appliquer la configuration Calico
      become: yes
      become_user: ubuntu
      shell: |
        kubectl apply -f /home/ubuntu/custom-resources.yaml
      register: calico_apply

    - name: Attendre que les pods Calico soient pr√™ts
      become: yes
      become_user: ubuntu
      shell: |
        kubectl wait --namespace calico-system \
          --for=condition=ready pod \
          --all \
          --timeout=180s
      register: calico_ready
      retries: 5
      delay: 15
      until: calico_ready.rc == 0
      ignore_errors: yes

    - name: V√©rifier l'√©tat de Calico
      become: yes
      become_user: ubuntu
      shell: |
        kubectl get pods -n calico-system
      register: calico_pods
      changed_when: false

    - name: Afficher l'√©tat de Calico
      debug:
        msg: "üì¶ Calico pods: {{ calico_pods.stdout_lines }}"

# ==================== PROMETHEUS/GRAFANA (Master seulement) ====================
- name: "üìä Installation de Prometheus Stack (Master seulement)"
  when: node_role == "master"
  block:
    - name: Installer Helm
      shell: |
        if ! command -v helm &> /dev/null; then 
          curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
        fi
      changed_when: false

    - name: Ajouter le repo Helm Prometheus
      become: yes
      become_user: ubuntu
      shell: |
        helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
        helm repo update
      register: helm_repo

    - name: Cr√©er le fichier de valeurs (sans stockage persistant)
      become: yes
      copy:
        dest: /home/ubuntu/prometheus-values.yaml
        content: |
          # Configuration sans stockage persistant (emptyDir)
          prometheus:
            prometheusSpec:
              retention: 3d
              resources:
                requests:
                  memory: 256Mi
                  cpu: 100m
                limits:
                  memory: 512Mi
                  cpu: 200m
              storageSpec:
                emptyDir: {}
          
          alertmanager:
            enabled: true
            alertmanagerSpec:
              resources:
                requests:
                  memory: 128Mi
                  cpu: 50m
                limits:
                  memory: 256Mi
                  cpu: 100m
              storage:
                emptyDir: {}
          
          grafana:
            enabled: true
            adminPassword: "admin"
            resources:
              requests:
                memory: 128Mi
                cpu: 50m
              limits:
                memory: 256Mi
                cpu: 100m
            persistence:
              enabled: false
            service:
              type: NodePort
              nodePort: 30300
            testFramework:
              enabled: false
          
          kube-state-metrics:
            resources:
              requests:
                memory: 100Mi
                cpu: 50m
              limits:
                memory: 200Mi
                cpu: 100m
        owner: ubuntu
        group: ubuntu

    - name: Installer/Mettre √† jour la stack Prometheus
      become: yes
      become_user: ubuntu
      shell: |
        export KUBECONFIG=/etc/kubernetes/admin.conf
        helm upgrade --install prometheus prometheus-community/kube-prometheus-stack \
          --namespace monitoring \
          --create-namespace \
          --values /home/ubuntu/prometheus-values.yaml \
          --wait \
          --timeout 5m \
          --atomic
      register: helm_install
      retries: 2
      delay: 30
      until: helm_install.rc == 0
      ignore_errors: yes

    - name: V√©rifier l'installation
      become: yes
      become_user: ubuntu
      shell: |
        kubectl get pods -n monitoring
      register: pods_status
      changed_when: false

    - name: Afficher les pods
      debug:
        msg: "üìä Monitoring pods: {{ pods_status.stdout_lines }}"

    - name: Obtenir l'IP locale du master
      shell: hostname -I | awk '{print $1}'
      register: master_ip_local
      changed_when: false

    - name: Afficher les informations d'acc√®s
      debug:
        msg:
          - "=========================================="
          - "‚úÖ Stack Prometheus install√©e avec succ√®s!"
          - "=========================================="
          - "üìä Grafana: http://{{ master_ip_local.stdout }}:30300"
          - "   Utilisateur: admin"
          - "   Mot de passe: admin"
          - ""
          - "‚ö†Ô∏è  Stockage temporaire (emptyDir) - pas de persistance"
          - "=========================================="

    - name: Cr√©er un fichier d'information
      copy:
        content: |
          Kubernetes Monitoring Stack
          ==========================
          Date: {{ ansible_date_time.iso8601 }}
          
          Grafana: http://{{ master_ip_local.stdout }}:30300 (admin/admin)
          
          Commandes:
          - kubectl get pods -n monitoring
          - kubectl logs -n monitoring deployment/prometheus-grafana
        dest: /home/ubuntu/monitoring-info.txt
        owner: ubuntu
        group: ubuntu
        mode: '0644'
