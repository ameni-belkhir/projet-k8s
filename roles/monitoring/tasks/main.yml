# monitoring/tasks/main.yml - FINAL FIXED VERSION

- name: Wait for CoreDNS deployment to be Available
  become_user: ubuntu
  command: kubectl wait --for=condition=Available deployment/coredns -n kube-system --timeout=600s
  retries: 10
  delay: 20
  register: coredns_wait
  until: coredns_wait.rc == 0

- name: Wait for Calico node daemonset to be Available
  become_user: ubuntu
  command: kubectl wait --for=condition=Available daemonset/calico-node -n kube-system --timeout=600s
  retries: 10
  delay: 20
  register: calico_wait
  until: calico_wait.rc == 0

- name: Wait for kube-proxy daemonset to be Available
  become_user: ubuntu
  command: kubectl wait --for=condition=Available daemonset/kube-proxy -n kube-system --timeout=600s
  retries: 10
  delay: 20
  register: kubeproxy_wait
  until: kubeproxy_wait.rc == 0

- name: Add Prometheus community Helm repo
  become_user: ubuntu
  kubernetes.core.helm_repository:
    name: prometheus-community
    repo_url: https://prometheus-community.github.io/helm-charts

- name: Deploy or upgrade kube-prometheus-stack
  become_user: ubuntu
  kubernetes.core.helm:
    name: prometheus
    chart_ref: prometheus-community/kube-prometheus-stack
    release_namespace: monitoring
    create_namespace: true
    wait: true
    timeout: 15m0s
    values:
      grafana:
        adminPassword: prom-operator  # Change this to something secure if desired
      prometheus:
        prometheusSpec:
          serviceMonitorSelectorNilUsesHelmValues: false
