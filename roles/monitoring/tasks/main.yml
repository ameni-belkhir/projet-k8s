# monitoring/tasks/main.yml - THIS VERSION USES DEPLOYMENT/DAEMONSET CONDITIONS (NO LABELS, GUARANTEED TO WORK)

- name: Wait for CoreDNS deployment to be Available
  become_user: ubuntu
  command: kubectl wait --for=condition=Available deployment/coredns -n kube-system --timeout=600s
  ignore_errors: yes  # Temporary to allow progress if somehow stuck; remove later

- name: Wait for Calico node daemonset to be Available
  become_user: ubuntu
  command: kubectl wait --for=condition=Available daemonset/calico-node -n kube-system --timeout=600s
  ignore_errors: yes

- name: Wait for kube-proxy daemonset to be Available
  become_user: ubuntu
  command: kubectl wait --for=condition=Available daemonset/kube-proxy -n kube-system --timeout=600s
  ignore_errors: yes

- name: Install Helm if not present
  shell: |
    if ! command -v helm >/dev/null 2>&1; then
      curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
    fi
  args:
    creates: /usr/local/bin/helm

- name: Add Prometheus Helm repo (if not already)
  shell: |
    helm repo add prometheus-community https://prometheus-community.github.io/helm-charts || true
    helm repo update

- name: Deploy kube-prometheus-stack
  become_user: ubuntu
  shell: |
    helm upgrade --install prometheus prometheus-community/kube-prometheus-stack \
      --namespace monitoring \
      --create-namespace \
      --wait \
      --timeout 15m0s \
      --set grafana.adminPassword=prom-operator
