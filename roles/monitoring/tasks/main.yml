---
# ==================== RÃ‰CUPÃ‰RER LE RÃ”LE ====================
- name: RÃ©cupÃ©rer le rÃ´le depuis l'environnement
  set_fact:
    node_role: "{{ lookup('env', 'NODE_ROLE') | default(node_role | default('')) }}"
    master_ip: "{{ lookup('env', 'MASTER_IP') | default(master_ip | default('')) }}"

# ==================== CALICO NETWORK (Master seulement) ====================
- name: "ðŸ“¦ Installation de Calico Network (Master seulement)"
  when: node_role == "master"
  block:
    - name: Configurer les permissions sur admin.conf pour l'utilisateur ubuntu
      file:
        path: /etc/kubernetes/admin.conf
        mode: '0644'

    - name: Installer l'opÃ©rateur Tigera Calico
      become: yes
      become_user: ubuntu
      shell: |
        kubectl create -f https://raw.githubusercontent.com/projectcalico/calico/v3.27.0/manifests/tigera-operator.yaml
      register: tigera_install
      until: tigera_install.rc == 0
      retries: 3
      delay: 10
      ignore_errors: yes

    - name: Attendre que l'opÃ©rateur Calico soit prÃªt
      become: yes
      become_user: ubuntu
      shell: |
        kubectl wait --namespace tigera-operator \
          --for=condition=ready pod \
          --selector name=tigera-operator \
          --timeout=120s
      register: operator_ready
      until: operator_ready.rc == 0
      retries: 5
      delay: 10
      ignore_errors: yes

    - name: CrÃ©er le fichier de configuration Calico
      copy:
        dest: /home/ubuntu/custom-resources.yaml
        content: |
          apiVersion: operator.tigera.io/v1
          kind: Installation
          metadata:
            name: default
          spec:
            calicoNetwork:
              ipPools:
              - blockSize: 26
                cidr: 192.168.0.0/16
                encapsulation: VXLANCrossSubnet
                natOutgoing: Enabled
                nodeSelector: all()
          ---
          apiVersion: operator.tigera.io/v1
          kind: APIServer
          metadata:
            name: default
          spec: {}
        owner: ubuntu
        group: ubuntu

    - name: Appliquer la configuration Calico
      become: yes
      become_user: ubuntu
      shell: |
        kubectl apply -f /home/ubuntu/custom-resources.yaml

    - name: Attendre que les pods Calico soient prÃªts (Crucial avant Helm)
      become: yes
      become_user: ubuntu
      shell: |
        kubectl wait --namespace calico-system --for=condition=ready pod --all --timeout=300s
      register: calico_ready
      until: calico_ready.rc == 0
      retries: 3
      delay: 20
      ignore_errors: yes

# ==================== PROMETHEUS/GRAFANA (Master seulement) ====================
- name: "ðŸ“Š Installation de Prometheus Stack (Master seulement)"
  when: node_role == "master"
  block:
    - name: Installer Helm
      shell: |
        if ! command -v helm &> /dev/null; then 
          curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
        fi
      changed_when: false

    - name: Ajouter le repo Helm Prometheus
      become: yes
      become_user: ubuntu
      shell: |
        helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
        helm repo update

    - name: CrÃ©er le fichier de valeurs Prometheus
      copy:
        dest: /home/ubuntu/prometheus-values.yaml
        content: |
          prometheus:
            prometheusSpec:
              retention: 3d
              storageSpec:
                emptyDir: {}
          grafana:
            adminPassword: "admin"
            persistence:
              enabled: false
            service:
              type: NodePort
              nodePort: 30300
        owner: ubuntu
        group: ubuntu

    - name: Installer la stack Prometheus via Helm
      become: yes
      become_user: ubuntu
      shell: |
        helm upgrade --install prometheus prometheus-community/kube-prometheus-stack \
          --namespace monitoring \
          --create-namespace \
          --values /home/ubuntu/prometheus-values.yaml \
          --wait --timeout 10m
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf

    - name: Afficher les informations d'accÃ¨s
      debug:
        msg:
          - "=========================================="
          - "âœ… Cluster K8s et Monitoring opÃ©rationnels"
          - "ðŸ“Š Grafana: http://{{ ansible_default_ipv4.address }}:30300"
          - "ðŸ‘¤ User: admin / Pass: admin"
          - "=========================================="
