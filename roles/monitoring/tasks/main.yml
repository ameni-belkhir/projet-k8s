# monitoring/tasks/main.yml - CORRECTED FOR YOUR EXACT SETUP

- name: Wait for CoreDNS pods to be Ready (correct label is kube-dns)
  become_user: ubuntu
  command: kubectl wait --for=condition=Ready pods -n kube-system -l k8s-app=kube-dns --timeout=600s
  retries: 15
  delay: 15
  register: coredns_wait
  until: coredns_wait.rc == 0

- name: Wait for Calico node pods to be Ready
  become_user: ubuntu
  command: kubectl wait --for=condition=Ready pods -n kube-system -l k8s-app=calico-node --timeout=600s
  retries: 15
  delay: 15
  register: calico_wait
  until: calico_wait.rc == 0

- name: Wait for kube-proxy pods to be Ready
  become_user: ubuntu
  command: kubectl wait --for=condition=Ready pods -n kube-system -l k8s-app=kube-proxy --timeout=600s
  retries: 15
  delay: 15
  register: kubeproxy_wait
  until: kubeproxy_wait.rc == 0

- name: Install Helm if not present
  shell: |
    if ! command -v helm >/dev/null 2>&1; then
      curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
    fi
  args:
    creates: /usr/local/bin/helm

- name: Update Helm repositories
  shell: helm repo update

- name: Deploy kube-prometheus-stack
  become_user: ubuntu
  shell: |
    helm upgrade --install prometheus prometheus-community/kube-prometheus-stack \
      --namespace monitoring \
      --create-namespace \
      --wait \
      --timeout 15m0s \
      --set grafana.adminPassword=prom-operator
  register: helm_deploy
  retries: 3
  delay: 30
  until: helm_deploy.rc == 0
